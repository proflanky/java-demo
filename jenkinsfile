pipeline {
    agent {
        // Use a Kubernetes agent or any other supported agent that has access to Kaniko
        kubernetes {
            yaml """
            apiVersion: v1
            kind: Pod
            metadata:
              labels:
                some-label: kaniko
            spec:
              containers:
              - name : jnlp
                image: jenkins/inbound-agent:3261.v9c670a_4748a_9-1
              - name: kaniko
                image: gcr.io/kaniko-project/executor:latest
                args: ["--context=dir://workspace/", "--dockerfile=Dockerfile", "--destination=docker.io/yourusername/your-image:latest"]
                volumeMounts:
                - name: docker-config
                  mountPath: /kaniko/.docker
              volumes:
              - name: docker-config
                secret:
                  secretName: docker-config-secret
            """
        }
    }
    environment {
        DOCKER_CONFIG = '/kaniko/.docker/' // Path to the Docker configuration
    }
    stages {
        stage('Checkout') {
            steps {
                // Checkout the code from the repository
                checkout scm
            }
        }
        stage('Build and Push') {
            steps {
                // Build the Docker image using Kaniko
                container('kaniko') {
                    sh 'echo "{\"auths\":{\"https://index.docker.io/v1/\":{\"username\":\"$DOCKER_USERNAME\",\"password\":\"$DOCKER_PASSWORD\"}}}" > /kaniko/.docker/config.json'
                    // The Kaniko build step will be handled by the args specified in the container YAML above
                }
            }
        }
    }
    post {
        always {
            // Clean up resources or notify upon completion
            echo 'Pipeline completed.'
        }
    }
}
